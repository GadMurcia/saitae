<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:h="http://xmlns.jcp.org/jsf/html">

    <body>
        <ui:composition template="./../WEB-INF/template/plantilla1.xhtml">

            <ui:define name="content">
                <h:outputScript library="js" name="locales.js"/>
                <h:form id="form">  
                    <p:growl id="msgs" showDetail="true" />

                    <h1 align="center">Administración de permisos de estudiantes</h1>
                    <p:accordionPanel id="ap" dynamic="true">
                        <p:tab title="Permisos Solicitados">
                            <p:dataTable id="solicitados" value="#{admPermisoController.solicitados}" var="p"
                                         paginator="true" rows="7" selection="#{admPermisoController.acep}" 
                                         selectionMode="single" rowKey="#{p.permisosPK}" 
                                         emptyMessage="Sin nuevos permisos solicitados aún.">
                                <p:ajax event="rowSelect" listener="#{admPermisoController.onRowSelect}" 
                                        update="sol" oncomplete="PF('Dsol').show();"/>
                                <p:column headerText="Fecha de solicitud" 
                                          filterMatchMode="contains" 
                                          filterBy="#{admPermisoController.dateToString(p.permisosPK.permisoFechaSolicit)}">
                                    #{admPermisoController.dateToString(p.permisosPK.permisoFechaSolicitud)}
                                </p:column>

                                <p:column headerText="Beneficiario"
                                          filterMatchMode="contains" filterBy="#{p.persona.personaNombre.split(' ')[0]} 
                                          #{p.persona.personaApellido.split(' ')[0]}">
                                    #{p.persona.personaNombre.split(' ')[0]} 
                                    #{p.persona.personaApellido.split(' ')[0]} 
                                    (#{p.persona.tipoPersona.tipoPersonaNombre})
                                </p:column>

                                <p:column headerText="Periodo del permiso">
                                    #{admPermisoController.getFechas(p.permisosPK.permisoFechaInicio, p.permisoFechafin)}
                                </p:column>

                                <p:column headerText="Tipo de permiso solicitado">
                                    #{p.tipoPermiso1.tipoPermisoNombre}
                                </p:column>
                            </p:dataTable>
                        </p:tab>
                        <p:tab title="Permisos Aceptados">
                            <h:panelGrid columns="2" cellpadding="10">
                                <p:dataTable id="aceptados" value="#{admPermisoController.aceptados}" var="a"
                                             paginator="true" rows="7" selection="#{admPermisoController.acep}" 
                                             selectionMode="single" rowKey="#{a.permisosPK}" 
                                             emptyMessage="Sin registros aún.">
                                    <p:ajax event="rowSelect" listener="#{admPermisoController.onRowSelect}" 
                                            update="ace" oncomplete="PF('Dotro').show();"/>

                                    <p:column headerText="Fecha de solicitud"
                                              filterMatchMode="contains" 
                                              filterBy="#{admPermisoController.dateToString(a.permisosPK.permisoFechaSolicitud)}">
                                        #{admPermisoController.dateToString(a.permisosPK.permisoFechaSolicitud)}
                                    </p:column>

                                    <p:column headerText="Beneficiario"
                                              filterMatchMode="contains" 
                                              filterBy="#{a.persona.personaNombre.split(' ')[0]} 
                                              #{a.persona.personaApellido.split(' ')[0]}">
                                        #{a.persona.personaNombre.split(' ')[0]} 
                                        #{a.persona.personaApellido.split(' ')[0]} 
                                        (#{a.persona.tipoPersona.tipoPersonaNombre})
                                    </p:column>

                                    <p:column headerText="Periodo del permiso">
                                        #{admPermisoController.getFechas(a.permisosPK.permisoFechaInicio, a.permisoFechafin)}
                                    </p:column>

                                    <p:column headerText="Tipo de permiso solicitado">
                                        #{a.tipoPermiso1.tipoPermisoNombre}
                                    </p:column>
                                </p:dataTable>
                            </h:panelGrid>
                        </p:tab>
                        <p:tab title="Permisos Rechazados">
                            <h:panelGrid columns="2" cellpadding="10">
                                <p:dataTable id="rachazados" value="#{admPermisoController.rechazados}" var="r"
                                             paginator="true" rows="7" selection="#{admPermisoController.acep}" 
                                             selectionMode="single" rowKey="#{r.permisosPK}" 
                                             emptyMessage="Sin registros aún.">
                                    <p:ajax event="rowSelect" listener="#{admPermisoController.onRowSelect}" 
                                            update="ace" oncomplete="PF('Dotro').show();"/>
                                    <p:column headerText="Fecha de solicitud"
                                              filterMatchMode="contains" 
                                              filterBy="#{admPermisoController.dateToString(r.permisosPK.permisoFechaSolicitud)}">
                                        #{admPermisoController.dateToString(r.permisosPK.permisoFechaSolicitud)}
                                    </p:column>

                                    <p:column headerText="Beneficiario"
                                              filterMatchMode="contains" 
                                              filterBy="#{r.persona.personaNombre.split(' ')[0]} 
                                              #{r.persona.personaApellido.split(' ')[0]}">
                                        #{r.persona.personaNombre.split(' ')[0]} 
                                        #{r.persona.personaApellido.split(' ')[0]} 
                                        (#{r.persona.tipoPersona.tipoPersonaNombre})
                                    </p:column>

                                    <p:column headerText="Periodo del permiso">
                                        #{admPermisoController.getFechas(r.permisosPK.permisoFechaInicio, r.permisoFechafin)}
                                    </p:column>

                                    <p:column headerText="Tipo de permiso solicitado">
                                        #{r.tipoPermiso1.tipoPermisoNombre}
                                    </p:column>
                                </p:dataTable>
                            </h:panelGrid>
                        </p:tab>
                        <p:tab title="Permisos Cancelados">
                            <h:panelGrid columns="2" cellpadding="10">
                                <p:dataTable id="cancelados" value="#{admPermisoController.cancelados}" var="r"
                                             paginator="true" rows="7" selection="#{admPermisoController.acep}" 
                                             selectionMode="single" rowKey="#{r.permisosPK}" 
                                             emptyMessage="Sin registros aún.">
                                    <p:ajax event="rowSelect" listener="#{admPermisoController.onRowSelect}" 
                                            update="ace" oncomplete="PF('Dotro').show();"/>
                                    <p:column headerText="Fecha de solicitud"
                                              filterMatchMode="contains" 
                                              filterBy="#{admPermisoController.dateToString(r.permisosPK.permisoFechaSolicitud)}">
                                        #{admPermisoController.dateToString(r.permisosPK.permisoFechaSolicitud)}
                                    </p:column>

                                    <p:column headerText="Beneficiario"
                                              filterMatchMode="contains" 
                                              filterBy="#{r.persona.personaNombre.split(' ')[0]} 
                                              #{r.persona.personaApellido.split(' ')[0]}">
                                        #{r.persona.personaNombre.split(' ')[0]} 
                                        #{r.persona.personaApellido.split(' ')[0]} 
                                        (#{r.persona.tipoPersona.tipoPersonaNombre})
                                    </p:column>

                                    <p:column headerText="Periodo del permiso">
                                        #{admPermisoController.getFechas(r.permisosPK.permisoFechaInicio, r.permisoFechafin)}
                                    </p:column>

                                    <p:column headerText="Tipo de permiso solicitado">
                                        #{r.tipoPermiso1.tipoPermisoNombre}
                                    </p:column>
                                </p:dataTable>
                            </h:panelGrid>
                        </p:tab>
                        <p:tab title="Conceder Permiso A Estudiantes">
                            <h:panelGrid columns="2">
                                <p:outputLabel for="nombus" value="Nombre del alumno:"/>
                                <p:autoComplete id="nombus" value="#{admPermisoController.nombreE}" 
                                                queryDelay="500" size="50"
                                                completeMethod="#{admPermisoController.completeText}">
                                    <p:ajax event="itemSelect" listener="#{admPermisoController.onItemSelect}"
                                            update="nombus summit"/>
                                </p:autoComplete>

                                <p:outputLabel for="tp" value="Tipo de permiso a conceder: "/>
                                <p:selectOneMenu id="tp" immediate="true" required="true" style="width: 400px;"
                                                 value="#{admPermisoController.permiso.tipoPermiso1}"
                                                 converter="omnifaces.SelectItemsConverter">
                                    <f:selectItem itemValue="null" itemLabel="Seleccione" noSelectionOption="true"/>
                                    <f:selectItems value="#{admPermisoController.tipoPermiso}" var="tpe"
                                                   itemValue="#{tpe}" itemLabel="#{tpe.tipoPermisoNombre}"/>
                                </p:selectOneMenu>

                                <p:outputLabel for="mot" value="Motivo de la solicitud: "/>
                                <p:inputText id="mot" value="#{admPermisoController.permiso.permisosMotivo}" 
                                             required="true" style="width: 400px;"/>

                                <p:outputLabel for="mask" value="Fecha de inicio:" />
                                <p:datePicker id="mask" value="#{admPermisoController.permiso.permisosPK.permisoFechaInicio}"
                                              showIcon="true" required="true" pattern="dd/MM/yyyy"/>

                                <p:outputLabel for="mask1" value="Fecha de finalización: " />
                                <p:datePicker id="mask1" value="#{admPermisoController.permiso.permisoFechafin}"
                                              showIcon="true" required="true" pattern="dd/MM/yyyy" />

                                <p:outputLabel for="dui" value="Dui del solicitante: "/>
                                <p:inputMask id="dui" value="#{admPermisoController.duiSol}" mask="99999999-9"
                                             required="true" style="width: 400px;">
                                    <p:ajax event="change" listener="#{admPermisoController.onblour}" update="dui"/>
                                </p:inputMask>

                                <p:outputLabel for="nomb" value="Nombres del solicitante: "/>
                                <p:inputText id="nomb" value="#{admPermisoController.nombreSol}" 
                                             required="true" style="width: 400px;"/>

                                <p:outputLabel for="apel" value="Apellidos del solicitante: "/>
                                <p:inputText id="apel" value="#{admPermisoController.apellidoSol}" 
                                             required="true" style="width: 400px;"/>

                                <p:column/>
                                <p:commandButton id="summit" value="Conceder" 
                                                 disabled="#{admPermisoController.permiso.persona==null}"
                                                 actionListener="#{admPermisoController.concederPermiso()}" 
                                                 update="ap"/>
                            </h:panelGrid>
                        </p:tab>
                    </p:accordionPanel>
                </h:form>

                <p:dialog widgetVar="Dsol" closeOnEscape="true" header="Detalle del permiso solicitado" modal="true"
                          responsive="true" >
                    <h:form id="sol">
                        <h:panelGrid columns="2" cellpadding="10" cellspacing="10">
                            <p:outputLabel value="Fecha de solicitud: "/>
                            <h:outputText value="#{admPermisoController
                                                   .getFecha(admPermisoController.solc.permisosPK.permisoFechaSolicitud)}"/>

                            <p:outputLabel value="Permiso solicitado: "/>
                            <h:outputText value="#{admPermisoController.solc.tipoPermiso1.tipoPermisoNombre}"/>

                            <p:outputLabel value="Motivo de solicitud: " 
                                           rendered="#{admPermisoController.VerMotivo(admPermisoController.solc)}"/>
                            <h:outputText value="#{admPermisoController.solc.permisosMotivo}"
                                          rendered="#{admPermisoController.VerMotivo(admPermisoController.solc)}"/>

                            <p:outputLabel value="Beneficiario: "/>
                            <h:outputText value="#{admPermisoController.solc.persona.personaNombre.split(' ')[0]} 
                                          #{admPermisoController.solc.persona.personaApellido.split(' ')[0]} 
                                          (#{admPermisoController.solc.persona.tipoPersona.tipoPersonaNombre})"/>

                            <p:outputLabel value="solicitado por: " 
                                           rendered="#{!admPermisoController.solc.persona.equals(admPermisoController.solc.permisosSolicitante)}"/>
                            <h:outputText value="#{admPermisoController.getSolicitadoPor(admPermisoController.acep)}" 
                                          rendered="#{!admPermisoController.solc.persona.equals(admPermisoController.solc.permisosSolicitante)}"/>

                            <p:outputLabel value="Fechas del permiso:"/>
                            <h:outputText value="#{admPermisoController.getFechas(
                                                   admPermisoController.solc.permisosPK.permisoFechaInicio,
                                                   admPermisoController.solc.permisoFechafin)}"/>

                            <p:commandButton value="Aceptar" actionListener="#{admPermisoController.guardar(1)}"
                                             oncomplete="PF('Dsol').hide();" update="form sol :form0:msgs"/>
                            <p:commandButton value="Rechazar" onclick="PF('Drechazo').show();" 
                                             update=":form rech"/>
                        </h:panelGrid>
                    </h:form>
                </p:dialog>

                <p:dialog widgetVar="Dotro" closeOnEscape="true" header="Detalle del permiso" modal="true"
                          responsive="true" >
                    <h:form id="ace">
                        <h:panelGrid columns="2" cellpadding="10" cellspacing="10">
                            <p:outputLabel value="Fecha de solicitud: "/>
                            <h:outputText value="#{admPermisoController
                                                   .getFecha(admPermisoController.acep.permisosPK.permisoFechaSolicitud)}"/>

                            <p:outputLabel value="Permiso solicitado: "/>
                            <h:outputText value="#{admPermisoController.acep.tipoPermiso1.tipoPermisoNombre}"/>

                            <p:outputLabel value="Motivo de solicitud: "
                                           rendered="#{admPermisoController.VerMotivo(admPermisoController.acep)}"/>
                            <h:outputText value="#{admPermisoController.acep.permisosMotivo}"
                                          rendered="#{admPermisoController.VerMotivo(admPermisoController.acep)}"/>

                            <p:outputLabel value="Beneficiario: "/>
                            <h:outputText value="#{admPermisoController.acep.persona.personaNombre.split(' ')[0]} 
                                          #{admPermisoController.acep.persona.personaApellido.split(' ')[0]} 
                                          (#{admPermisoController.acep.persona.tipoPersona.tipoPersonaNombre})"/>

                            <p:outputLabel value="solicitado por: " 
                                           rendered="#{!admPermisoController.acep.persona.equals(admPermisoController.acep.permisosSolicitante)}"/>
                            <h:outputText value="#{admPermisoController.getSolicitadoPor(admPermisoController.acep)}" 
                                          rendered="#{!admPermisoController.acep.persona.equals(admPermisoController.acep.permisosSolicitante)}"/>

                            <p:outputLabel value="Fechas del permiso:"/>
                            <h:outputText value="#{admPermisoController.getFechas(
                                                   admPermisoController.acep.permisosPK.permisoFechaInicio,
                                                   admPermisoController.acep.permisoFechafin)}"/>

                            <p:outputLabel value="Estado del permiso: "/>
                            <h:outputText value="#{admPermisoController.acep.permisosEstado.equals('1')
                                                   ? 'Aceptado' : (admPermisoController.acep.permisosEstado.equals('2')
                                                   ? 'Rechazado': (admPermisoController.acep.permisosEstado.equals('3')
                                                   ? 'Cancelado': '????'))}"/>

                            <p:outputLabel value="Motivo del rechazo: " 
                                           rendered="#{admPermisoController.acep.permisosEstado.equals('2')}"/>
                            <h:outputText value="#{admPermisoController.comentarioAcep}"
                                          rendered="#{admPermisoController.acep.permisosEstado.equals('2')}"/>

                            <p:outputLabel value="Motivo de la cancelación: " 
                                           rendered="#{admPermisoController.acep.permisosEstado.equals('3')}"/>
                            <h:outputText value="#{admPermisoController.comentarioAcep}"
                                          rendered="#{admPermisoController.acep.permisosEstado.equals('3')}"/>
                        </h:panelGrid>
                    </h:form>
                </p:dialog>
                <p:dialog widgetVar="Drechazo" closeOnEscape="true" header="Razón del rechazo del permiso" modal="true"
                          responsive="true" onHide="PF('Dsol').hide();">
                    <h:form id="rech">
                        <h:panelGrid columns="2" cellspacing="5">
                            <p:outputLabel for="rec" value="Especifique la razón por la que rechaza el permiso: "/>
                            <p:inputText id="rec" value="#{admPermisoController.comentarioSolc}" required="true"/>

                            <p:column/>
                            <p:commandButton value="Rechazar" actionListener="#{admPermisoController.guardar(2)}"
                                             oncomplete="PF('Drechazo').hide(); PF('Dsol').hide();" 
                                             update="rech form sol :form0:msgs"/>
                        </h:panelGrid>
                    </h:form>
                </p:dialog>
            </ui:define>

        </ui:composition>
    </body>
</html>
